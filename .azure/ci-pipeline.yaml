trigger:
  - main

pool:
  name: default
  demands: agent.os -equals Linux

stages:
  - stage: UnitTest
    displayName: Unit Test
    jobs:
      - job: Execute
        steps:
          - bash: echo "Run Unit Test!"
  - stage: BuildAndPush
    displayName: Build and Push Docker Image
    jobs:
      - job: Build
        strategy:
          maxParallel: 2
          matrix:
            api-service:
              service: api
            web-service:
              service: web
        steps:
          - task: Docker@2
            displayName: Login to Docker Hub
            inputs:
              command: login
              containerRegistry: dockerHubRegistryPrimary
          - task: Docker@2
            displayName: Build and Push
            inputs:
              command: buildAndPush
              containerRegistry: dockerHubRegistryPrimary
              Dockerfile: services/$(service)/Dockerfile.k8s
              buildContext: services/$(service)
              repository: azuredevtest/$(service)
              tags: |
                latest




